{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}AURIN{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .product-image {
            transition: transform 0.3s ease;
        }
        
        .product-card:hover .product-image {
            transform: scale(1.05);
        }
        
        .nav-link {
            position: relative;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 1px;
            background-color: black;
        }

        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 1px;
            background-color: black;
        }

        /* Mobile menu styles */
        .mobile-menu {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        
        .mobile-menu.open {
            transform: translateX(0);
        }
        
        .hamburger {
            cursor: pointer;
        }
        
        .hamburger span {
            display: block;
            width: 25px;
            height: 2px;
            background-color: black;
            margin: 5px 0;
            transition: 0.3s;
        }
        
        .hamburger.active span:nth-child(1) {
            transform: rotate(-45deg) translate(-5px, 6px);
        }
        
        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }
        
        .hamburger.active span:nth-child(3) {
            transform: rotate(45deg) translate(-5px, -6px);
        }

        /* Overlay */
        .overlay {
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease-in-out;
        }
        
        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* HTMX loading indicator */
        .htmx-indicator {
            opacity: 0;
            transition: opacity 200ms ease-in;
        }
        .htmx-request .htmx-indicator {
            opacity: 1;
        }
        .htmx-request.htmx-indicator {
            opacity: 1;
        }

        #wishlist-overlay {
        opacity: 0;
        visibility: hidden;
        }
        #wishlist-overlay.open {
        opacity: 1;
        visibility: visible;
        }
        #wishlist-overlay.closed {
        opacity: 0;
        visibility: hidden;
        }

        .dotted-input {
        border: none;
        border-bottom: 2px dotted #d1d5db;
        background: transparent;
        outline: none;
        transition: border-color 0.3s ease;
        }
        .dotted-input:focus {
            border-bottom-color: #374151;
        }
        .dotted-input::placeholder {
            color: #6b7280;
            font-weight: 500;
        }

        /* Dropdown подменю */
        .group:hover .group-hover\:opacity-100 {
            opacity: 1;
            visibility: visible;
        }

        .dropdown-menu {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease-in-out;
        }

        /*Анимация при скрол*/
        .animate-fade-in {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.6s ease-out;
        }
        .animate-fade-in.visible {
        opacity: 1;
        transform: translateY(0);
        }

        /* без underline вътре в sidebar */
        .account-sidebar .nav-link::after { content:none !important; display:none !important; }

        /* индикатор – малък правоъгълник */
        .account-sidebar .nav-link { position:relative; padding:8px 0 8px 18px; }
        .account-sidebar .nav-link.is-active::before{
        content:""; position:absolute; left:0; top:50%; transform:translateY(-50%);
        width:3px; height:14px; border-radius:2px; background:#9ca3af;
        }
    </style>

</head>
<body class="bg-white">
    <!-- Header -->
    <header class="fixed top-0 left-0 w-full z-50 bg-white shadow-sm">
        <div class="mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Mobile Menu Button -->
                <button id="menuToggle" class="hamburger md:hidden">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                
                <!-- Logo -->
                <div class="flex-shrink-0">
                    <a href="{% url 'main:index' %}" 
                       hx-get="{% url 'main:index' %}" 
                       hx-target="#main-content" 
                       hx-push-url="true">
                        <h1 class="text-sm sm:text-lg font-bold tracking-tight text-left">
                            AURIN
                        </h1>
                    </a>
                </div>
                
                <!-- Desktop Navigation -->
                <nav class="hidden md:flex space-x-8">
                    {% for parent in categories %}
                    <div class="relative group">
                        <button class="nav-link text-sm font-medium text-gray-900 hover:text-gray-700">
                            {{ parent.name|upper }}
                        </button>

                        {% if parent.subcategories.all %}
                        <div class="absolute left-0 mt-2 w-40 bg-white shadow-lg opacity-0 group-hover:opacity-100 transition duration-200 z-50">
                            <ul class="py-2">
                                {% for subcat in parent.subcategories.all %}
                                <li>
                                    <a href="{% url 'main:catalog' subcat.slug %}"
                                    hx-get="{% url 'main:catalog' subcat.slug %}"
                                    hx-target="#main-content"
                                    hx-push-url="true"
                                    class="block px-4 py-2 text-sm text-gray-800 hover:bg-gray-100">
                                        {{ subcat.name }}
                                    </a>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </nav>
                
                <!-- Right side links -->
                <div class="hidden md:flex items-center space-x-6">
                    <div class="relative" id="mobile-search-wrapper">
                        <button id="mobile-search-toggle" 
                                hx-get="{% url 'main:catalog_all' %}?show_search=true" 
                                hx-target="#mobile-search-wrapper" 
                                hx-swap="innerHTML"
                                class="text-sm font-medium uppercase hover:text-gray-600">
                            {% trans "SEARCH" %}
                        </button>
                    </div>
                    <a href="{% url 'users:profile' %}" 
                    hx-get="{% url 'users:profile' %}" 
                    hx-target="#main-content" 
                    hx-push-url="true"
                    class="text-sm font-medium text-gray-900 uppercase hover:text-gray-600">
                        {% trans "ACCOUNT" %}
                    </a>

                    {% include "wishlist/includes/wishlist_button.html" %}

                    <a href="#" id="desktopCart" class="text-sm font-medium text-gray-900 hover:text-gray-700">{% trans "CART" %} (0)</a>
                </div>
                
                <!-- Mobile Cart Icon -->
                <div class="md:hidden">
                    <a href="#" id="mobileCartHeader" class="text-xs font-medium text-gray-900">{% trans "CART" %} (0)</a>
                </div>
                <form action="{% url 'set_language' %}" method="post" class="hidden md:block">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                {% get_current_language as LANGUAGE_CODE %}
                {% get_available_languages as LANGUAGES %}
                <select name="language"
                        onchange="this.form.submit()"
                        class="text-xs font-medium uppercase hover:text-gray-600 border border-gray-300 px-2 py-1 rounded">
                    {% for code, name in LANGUAGES %}
                    <option value="{{ code }}" {% if code == LANGUAGE_CODE %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
                </form>
            </div>
        </div>
    </header>

    <!-- Mobile Menu Overlay -->
    <div id="overlay"
        class="overlay fixed inset-0 top-16 bg-black bg-opacity-50 z-40 md:hidden"></div>
    
    <!-- Mobile Menu -->
    <div id="mobileMenu"
        class="mobile-menu fixed top-16 left-0 w-80 h-[calc(100vh-4rem)] bg-white z-50 md:hidden shadow-lg">
        <div class="p-6">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-lg font-bold tracking-tight text-left">
                    AURIN
                </h2>   
                <button id="closeMenu" class="hamburger active">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            
            <nav class="space-y-4">
            <a href="{% url 'main:index' %}" 
                hx-get="{% url 'main:index' %}" 
                hx-target="#main-content" 
                hx-push-url="true"
                class="mobile-nav-link block text-lg font-medium text-gray-900 hover:text-gray-700 py-2 border-b border-gray-200">
                {% trans "HOME" %}
            </a>

            {% for parent in categories %}
                <div>
                <button type="button"
                        data-target="subcat-{{ parent.slug }}"
                        class="mobile-category-toggle w-full text-left text-lg font-medium text-gray-900 flex justify-between items-center py-2 border-b border-gray-200">
                    {{ parent.name|upper }}
                    <span class="text-xl">+</span>
                </button>

                <div id="subcat-{{ parent.slug }}" class="ml-4 mt-2 space-y-1 hidden">
                    {% for subcat in parent.subcategories.all %}
                    <a href="{% url 'main:catalog' subcat.slug %}"
                        hx-get="{% url 'main:catalog' subcat.slug %}"
                        hx-target="#main-content"
                        hx-push-url="true"
                        class="block text-sm text-gray-800 hover:text-black">
                        {{ subcat.name }}
                    </a>
                    {% endfor %}
                </div>
                </div>
            {% endfor %}
            </nav>
            
            <div class="mt-8 space-y-4">
                <a href="#" class="block text-sm font-medium text-gray-900 hover:text-gray-700 py-2">{% trans "SEARCH" %}</a>
                <a href="{% url 'users:profile' %}" 
                hx-get="{% url 'users:profile' %}" 
                hx-target="#main-content" 
                hx-push-url="true"
                class="text-sm font-medium text-gray-900 uppercase hover:text-gray-600">
                    {% trans "ACCOUNT" %}
                </a>
                <!-- Група Wishlist + Cart с по-малко разстояние -->
                <div class="space-y-1">
                    <a href="#"
                    id="mobileWishlist"
                    class="block text-sm font-medium text-gray-900 hover:text-gray-700 py-2"
                    hx-get="/wishlist/modal/"
                    hx-target="#wishlist-container"
                    hx-swap="innerHTML">
                    {% trans "WISHLIST" %} (<span id="wishlist-count-mobile">{{ wishlist_count|default:0 }}</span>)
                    </a>

                    <a href="#"
                    id="mobileCart"
                    class="block text-sm font-medium text-gray-900 hover:text-gray-700 py-2">
                    {% trans "CART" %} (0)
                    </a>
                </div>
            </div>
            <form action="{% url 'set_language' %}" method="post" class="mt-2">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            {% get_current_language as LANGUAGE_CODE %}
            {% get_available_languages as LANGUAGES %}
            <select name="language"
                    onchange="this.form.submit()"
                    class="block w-full text-sm border border-gray-300 px-2 py-2 rounded">
                {% for code, name in LANGUAGES %}
                <option value="{{ code }}" {% if code == LANGUAGE_CODE %}selected{% endif %}>{{ name }}</option>
                {% endfor %}
            </select>
            </form>
        </div>
    </div>

    
    <div id="cart-container"></div>

    <!-- Mounts for dynamic wishlist content -->
    <div id="wishlist-container"></div>

    <div id="wishlist-toast-container"></div>

    <div id="login-modal-container"></div>

    <div id="get-the-look-container"></div>



    <!-- Loading Indicator -->
    <div class="htmx-indicator fixed top-0 left-0 w-full h-1 bg-black z-50"></div>

    <!-- Main Content -->
    <div id="main-content" class="pt-16">
        {% block content %}
            {% if initial_content_template %}
                {% include initial_content_template %}
            {% else %}
                {% include 'main/home_content.html' %}
            {% endif %}
        {% endblock %}
    </div>



    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const CART_LABEL = "{% trans 'CART' %}";
            const menuToggle = document.getElementById('menuToggle');
            const closeMenu  = document.getElementById('closeMenu');
            const mobileMenu = document.getElementById('mobileMenu');
            const overlay    = document.getElementById('overlay');

            function openMobileMenu() {
                if (mobileMenu) mobileMenu.classList.add('open');
                if (menuToggle) menuToggle.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            function closeMobileMenu() {
                if (mobileMenu) mobileMenu.classList.remove('open');
                if (overlay) overlay.classList.remove('active');
                if (menuToggle) menuToggle.classList.remove('active'); // <-- вече е защитено
                document.body.style.overflow = '';
            }

            if (menuToggle) menuToggle.addEventListener('click', openMobileMenu);
            if (closeMenu)  closeMenu.addEventListener('click', closeMobileMenu);
            if (overlay)    overlay.addEventListener('click', closeMobileMenu);

            // Затваряй мобилното меню след HTMX навигация
            document.addEventListener('htmx:afterRequest', closeMobileMenu);

            // 🆕 Accordion toggles for mobile categories
            const toggles = document.querySelectorAll('.mobile-category-toggle');

            toggles.forEach(toggle => {
                toggle.addEventListener('click', function () {
                    const targetId = this.dataset.target;
                    const target = document.getElementById(targetId);

                    if (target) {
                        target.classList.toggle('hidden');
                    }
                });
            });

            //Js за Анимация
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                }
                });
            });

            document.querySelectorAll('.animate-fade-in').forEach(el => observer.observe(el));

            // Cart functionality
            const desktopCart = document.getElementById('desktopCart');
            const mobileCart = document.getElementById('mobileCart');
            const mobileCartHeader = document.getElementById('mobileCartHeader');
            
            // Get initial cart count
            updateCartCount();
            
            function updateHeaderCartCount(count) {
                const desktopCart = document.getElementById('desktopCart');
                const mobileCart = document.getElementById('mobileCart');
                const mobileCartHeader = document.getElementById('mobileCartHeader');

                const cartText = `${CART_LABEL} (${count})`;

                if (desktopCart) desktopCart.textContent = cartText;
                if (mobileCart) mobileCart.textContent = cartText;
                if (mobileCartHeader) mobileCartHeader.textContent = cartText;

                console.log('🛒 Updated header cart count to:', cartText);
            }


            
            function updateCartCount() {
                fetch('{% url "cart:cart_count" %}')
                    .then(response => response.json())
                    .then(data => {
                        updateHeaderCartCount(data.total_items);
                    });
            }

            
            function openCart() {
                htmx.ajax('GET', '{% url "cart:cart_modal" %}', {
                    target: '#cart-container',
                    swap: 'innerHTML'
                });
            }

    
            [desktopCart, mobileCart, mobileCartHeader].forEach(cartLink => {
                if (cartLink) {
                    cartLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        openCart();
                    });
                }
            });

            document.addEventListener('htmx:afterSwap', () => {
                const desktop = document.querySelector('#wishlist-button #wishlist-count');
                const mobile  = document.getElementById('wishlist-count-mobile');
                if (desktop && mobile) {
                    mobile.textContent = desktop.textContent;
                }
            });
    
            // Close mobile menu on window resize
            window.addEventListener('resize', function() {
                if (window.innerWidth >= 768) {
                    closeMobileMenu();
                }
            });
    
            // Update active navigation links after HTMX requests
            document.addEventListener('htmx:afterSettle', function() {
                updateActiveNavLinks();
            });
    
            function updateActiveNavLinks() {
                const currentPath = window.location.pathname;
                const navLinks = document.querySelectorAll('.nav-link, .mobile-nav-link');
                
                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href') === currentPath) {
                        link.classList.add('active');
                    }
                });
            }
            
            // Listen for cart updates
            document.addEventListener('cartUpdated', function(e) {
                if (e.detail && e.detail.total_items !== undefined) {
                    updateHeaderCartCount(e.detail.total_items);
                }
            });
        });
        
        // Global function to update cart count
        window.updateHeaderCartCount = function(count) {
            const desktopCart = document.getElementById('desktopCart');
            const mobileCart = document.getElementById('mobileCart');
            const mobileCartHeader = document.getElementById('mobileCartHeader');
            const cartText = `${CART_LABEL} (${count})`;
            
            if (desktopCart) desktopCart.textContent = cartText;
            if (mobileCart) mobileCart.textContent = cartText;
            if (mobileCartHeader) mobileCartHeader.textContent = cartText;
        };

            function handleWishlistButtonClick(btn) {
            const isAuth = btn.dataset.authenticated === "true";
            const url = btn.dataset.url;

            if (!isAuth) {
                htmx.ajax('GET', "{% url 'users:login' %}?next=/wishlist/modal/", {
                    target: '#main-content',
                    pushUrl: true,
                    swap: 'innerHTML'
                });
                return;
            }

            htmx.ajax('GET', url, {
                target: '#wishlist-container',
                swap: 'innerHTML'
            });
        }


            function closeWishlistModal() {
            const c = document.getElementById('wishlist-container');
            if (c) c.innerHTML = '';
            }

            document.addEventListener('htmx:afterSwap', function (evt) {
            // When the modal HTML lands in #wishlist-container, it’s ready
            if (evt.detail.elt.id === 'wishlist-container') {
                // nothing else needed if you don't animate
            }
            });

            // Optional helper if you want to update the header count manually somewhere
            function updateWishlistCount(count) {
            const el = document.getElementById('wishlist-count');
            if (el) el.textContent = count;
            }

            document.addEventListener("htmx:configRequest", function(event) {
                const csrfToken = getCookie("csrftoken");
                if (csrfToken) {
                    event.detail.headers["X-CSRFToken"] = csrfToken;
                }
            });

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== "") {
                    const cookies = document.cookie.split("; ");
                    for (let i = 0; i < cookies.length; i++) {
                        const [key, value] = cookies[i].split("=");
                        if (key === name) {
                            cookieValue = decodeURIComponent(value);
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            window.updateCartCountFromDOM = function() {
                const items = document.querySelectorAll('#cart-modal .cart-item');
                updateHeaderCartCount(items.length);
            }

            function showNotification(message) {
                const notification = document.createElement('div');
                notification.className = 'fixed top-20 right-4 bg-black text-white px-6 py-3 rounded shadow-lg z-50 transform translate-x-full transition-transform duration-300';
                notification.textContent = message;
                document.body.appendChild(notification);
                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 10);
                setTimeout(() => {
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, 3000);
            }

            function updateHeaderWishlistCount(count) {
                const el = document.querySelector('#wishlist-button #wishlist-count');
                if (el) el.textContent = count;
            }


            document.addEventListener("htmx:afterSwap", function(event) {
                // Обнови wishlist брояча
                if (event.detail.target && event.detail.target.id === "wishlist-container") {
                    const items = document.querySelectorAll('#wishlist-container .cart-item');
                    updateHeaderWishlistCount(items.length);
                }

                // Обнови cart брояча
                if (event.detail.target && event.detail.target.id === "cart-container") {
                    const modal = document.getElementById('cart-modal');
                    const total = modal?.dataset?.totalItems;
                    if (total !== undefined) {
                        updateHeaderCartCount(parseInt(total));
                    }
                }
            });

            // Изпълнява <script> тагове от инжектиран фрагмент (inline и с src)
            function runScriptsFrom(container) {
                const scripts = container.querySelectorAll('script');
                scripts.forEach(oldScript => {
                const newScript = document.createElement('script');
                // копирай type, src, attrs
                for (const { name, value } of oldScript.attributes) {
                    newScript.setAttribute(name, value);
                }
                // ако е inline – прехвърли кода
                if (!oldScript.src) {
                    newScript.text = oldScript.textContent;
                }
                // за да сработи изпълнението, трябва да го закачим към DOM
                oldScript.parentNode.replaceChild(newScript, oldScript);
                });
            }
            window.runScriptsFrom = runScriptsFrom;

            // След като HTMX смени #main-content, изпълни скриптовете вътре
            document.addEventListener('htmx:afterSwap', function (e) {
                const t = e.detail && e.detail.target;
                if (!t) return;
                if (t.id === 'main-content' || t.id === 'profile-main-content') {
                    runScriptsFrom(t);
                }
            });


            // Покрива и back/forward кеш (bfcache), когато се върнеш на страницата
            window.addEventListener('pageshow', function () {
                const main = document.getElementById('main-content');
                if (main) runScriptsFrom(main);
            });

    </script>
</body>
</html>